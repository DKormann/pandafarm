var zr=Object.defineProperty;var Ir=(e,t,i)=>t in e?zr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var p=(e,t,i)=>(Ir(e,typeof t!="symbol"?t+"":t,i),i),Je=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)};var n=(e,t,i)=>(Je(e,t,"read from private field"),i?i.call(e):t.get(e)),h=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)},d=(e,t,i,s)=>(Je(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i);var y=(e,t,i)=>(Je(e,t,"access private method"),i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function i(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerpolicy&&(a.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?a.credentials="include":r.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=i(r);fetch(r.href,a)}})();class Vt{constructor(t){p(this,"value");p(this,"listeners",[]);this.value=t}get(){return this.value}set(t,i=!1){if(!(!i&&t===this.value)){for(const s of this.listeners)s(t);this.value=t}}update(t){const i=t(this.value);this.set(i)}subscribe(t){this.listeners.push(t),t(this.value)}subscribeLater(t){this.listeners.push(t)}}class Ur extends Vt{constructor(i,s){localStorage.getItem(i)!==null&&(s=JSON.parse(localStorage.getItem(i)));super(s);p(this,"key");this.key=i}set(i){JSON.stringify(this.get())!==JSON.stringify(i)&&(super.set(i),localStorage.setItem(this.key,JSON.stringify(i)))}}var A,b,Zt,ne=(Zt=class{constructor(e){h(this,A,void 0);h(this,b,0);d(this,A,new DataView(e.buffer)),d(this,b,e.byteOffset)}get offset(){return n(this,b)}readUInt8Array(){const e=this.readU32(),t=new Uint8Array(n(this,A).buffer,n(this,b),e);return d(this,b,n(this,b)+e),t}readBool(){const e=n(this,A).getUint8(n(this,b));return d(this,b,n(this,b)+1),e!==0}readByte(){const e=n(this,A).getUint8(n(this,b));return d(this,b,n(this,b)+1),e}readBytes(e){const t=new DataView(n(this,A).buffer,n(this,b),e);return d(this,b,n(this,b)+e),new Uint8Array(t.buffer)}readI8(){const e=n(this,A).getInt8(n(this,b));return d(this,b,n(this,b)+1),e}readU8(){const e=n(this,A).getUint8(n(this,b));return d(this,b,n(this,b)+1),e}readI16(){const e=n(this,A).getInt16(n(this,b),!0);return d(this,b,n(this,b)+2),e}readU16(){const e=n(this,A).getUint16(n(this,b),!0);return d(this,b,n(this,b)+2),e}readI32(){const e=n(this,A).getInt32(n(this,b),!0);return d(this,b,n(this,b)+4),e}readU32(){const e=n(this,A).getUint32(n(this,b),!0);return d(this,b,n(this,b)+4),e}readI64(){const e=n(this,A).getBigInt64(n(this,b),!0);return d(this,b,n(this,b)+8),e}readU64(){const e=n(this,A).getBigUint64(n(this,b),!0);return d(this,b,n(this,b)+8),e}readU128(){const e=n(this,A).getBigUint64(n(this,b),!0),t=n(this,A).getBigUint64(n(this,b)+8,!0);return d(this,b,n(this,b)+16),(t<<BigInt(64))+e}readI128(){const e=n(this,A).getBigUint64(n(this,b),!0),t=n(this,A).getBigInt64(n(this,b)+8,!0);return d(this,b,n(this,b)+16),(t<<BigInt(64))+e}readU256(){const e=n(this,A).getBigUint64(n(this,b),!0),t=n(this,A).getBigUint64(n(this,b)+8,!0),i=n(this,A).getBigUint64(n(this,b)+16,!0),s=n(this,A).getBigUint64(n(this,b)+24,!0);return d(this,b,n(this,b)+32),(s<<BigInt(3*64))+(i<<BigInt(2*64))+(t<<BigInt(1*64))+e}readI256(){const e=n(this,A).getBigUint64(n(this,b),!0),t=n(this,A).getBigUint64(n(this,b)+8,!0),i=n(this,A).getBigUint64(n(this,b)+16,!0),s=n(this,A).getBigInt64(n(this,b)+24,!0);return d(this,b,n(this,b)+32),(s<<BigInt(3*64))+(i<<BigInt(2*64))+(t<<BigInt(1*64))+e}readF32(){const e=n(this,A).getFloat32(n(this,b),!0);return d(this,b,n(this,b)+4),e}readF64(){const e=n(this,A).getFloat64(n(this,b),!0);return d(this,b,n(this,b)+8),e}readString(){const e=this.readU32(),t=new Uint8Array(n(this,A).buffer,n(this,b),e),s=new TextDecoder("utf-8").decode(t);return d(this,b,n(this,b)+e),s}},A=new WeakMap,b=new WeakMap,Zt),q,z,f,k,E,Xt,Ge=(Xt=class{constructor(e){h(this,k);h(this,q,void 0);h(this,z,void 0);h(this,f,0);d(this,q,new Uint8Array(e)),d(this,z,new DataView(n(this,q).buffer))}getBuffer(){return n(this,q).slice(0,n(this,f))}writeUInt8Array(e){const t=e.length;y(this,k,E).call(this,4+t),this.writeU32(t),n(this,q).set(e,n(this,f)),d(this,f,n(this,f)+e.length)}writeBool(e){y(this,k,E).call(this,1),n(this,z).setUint8(n(this,f),e?1:0),d(this,f,n(this,f)+1)}writeByte(e){y(this,k,E).call(this,1),n(this,z).setUint8(n(this,f),e),d(this,f,n(this,f)+1)}writeI8(e){y(this,k,E).call(this,1),n(this,z).setInt8(n(this,f),e),d(this,f,n(this,f)+1)}writeU8(e){y(this,k,E).call(this,1),n(this,z).setUint8(n(this,f),e),d(this,f,n(this,f)+1)}writeI16(e){y(this,k,E).call(this,2),n(this,z).setInt16(n(this,f),e,!0),d(this,f,n(this,f)+2)}writeU16(e){y(this,k,E).call(this,2),n(this,z).setUint16(n(this,f),e,!0),d(this,f,n(this,f)+2)}writeI32(e){y(this,k,E).call(this,4),n(this,z).setInt32(n(this,f),e,!0),d(this,f,n(this,f)+4)}writeU32(e){y(this,k,E).call(this,4),n(this,z).setUint32(n(this,f),e,!0),d(this,f,n(this,f)+4)}writeI64(e){y(this,k,E).call(this,8),n(this,z).setBigInt64(n(this,f),e,!0),d(this,f,n(this,f)+8)}writeU64(e){y(this,k,E).call(this,8),n(this,z).setBigUint64(n(this,f),e,!0),d(this,f,n(this,f)+8)}writeU128(e){y(this,k,E).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),i=e>>BigInt(64);n(this,z).setBigUint64(n(this,f),t,!0),n(this,z).setBigUint64(n(this,f)+8,i,!0),d(this,f,n(this,f)+16)}writeI128(e){y(this,k,E).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),i=e>>BigInt(64);n(this,z).setBigInt64(n(this,f),t,!0),n(this,z).setBigInt64(n(this,f)+8,i,!0),d(this,f,n(this,f)+16)}writeU256(e){y(this,k,E).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),i=e&t,s=e>>BigInt(64*1)&t,r=e>>BigInt(64*2)&t,a=e>>BigInt(64*3);n(this,z).setBigUint64(n(this,f)+8*0,i,!0),n(this,z).setBigUint64(n(this,f)+8*1,s,!0),n(this,z).setBigUint64(n(this,f)+8*2,r,!0),n(this,z).setBigUint64(n(this,f)+8*3,a,!0),d(this,f,n(this,f)+32)}writeI256(e){y(this,k,E).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),i=e&t,s=e>>BigInt(64*1)&t,r=e>>BigInt(64*2)&t,a=e>>BigInt(64*3);n(this,z).setBigUint64(n(this,f)+8*0,i,!0),n(this,z).setBigUint64(n(this,f)+8*1,s,!0),n(this,z).setBigUint64(n(this,f)+8*2,r,!0),n(this,z).setBigInt64(n(this,f)+8*3,a,!0),d(this,f,n(this,f)+32)}writeF32(e){y(this,k,E).call(this,4),n(this,z).setFloat32(n(this,f),e,!0),d(this,f,n(this,f)+4)}writeF64(e){y(this,k,E).call(this,8),n(this,z).setFloat64(n(this,f),e,!0),d(this,f,n(this,f)+8)}writeString(e){const i=new TextEncoder().encode(e);this.writeU32(i.length),y(this,k,E).call(this,i.length),n(this,q).set(i,n(this,f)),d(this,f,n(this,f)+i.length)}},q=new WeakMap,z=new WeakMap,f=new WeakMap,k=new WeakSet,E=function(e){const t=n(this,f)+e+1;if(t<=n(this,q).length)return;let i=n(this,q).length*2;i<t&&(i=t);const s=new Uint8Array(i);s.set(n(this,q)),d(this,q,s),d(this,z,new DataView(n(this,q).buffer))},Xt);function ke(e,t){if(e===t)return!0;if(typeof e!="object"||e===null||typeof t!="object"||t===null)return!1;const i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(let r of i)if(!s.includes(r)||!ke(e[r],t[r]))return!1;return!0}function ir(e){return Array.prototype.map.call(e.reverse(),t=>("00"+t.toString(16)).slice(-2)).join("")}function vr(e){if(e.length!=16)throw new Error(`Uint8Array is not 16 bytes long: ${e}`);return new ne(e).readU128()}function _r(e){if(e.length!=32)throw new Error(`Uint8Array is not 32 bytes long: [${e}]`);return new ne(e).readU256()}function nr(e){e.startsWith("0x")&&(e=e.slice(2));let t=e.match(/.{1,2}/g)||[],i=Uint8Array.from(t.map(s=>parseInt(s,16)));return i.length!=32?new Uint8Array(0):i.reverse()}function Fr(e){return vr(nr(e))}function Cr(e){return _r(nr(e))}function sr(e){let t=new Ge(16);return t.writeU128(e),t.getBuffer()}function kr(e){return ir(sr(e))}function ar(e){let t=new Ge(32);return t.writeU256(e),t.getBuffer()}function Er(e){return ir(ar(e))}var Xe=class Fe{constructor(t){p(this,"data");this.data=t}get __connection_id__(){return this.data}isZero(){return this.data===BigInt(0)}static nullIfZero(t){return t.isZero()?null:t}static random(){function t(){return Math.floor(Math.random()*255)}let i=BigInt(0);for(let s=0;s<16;s++)i=i<<BigInt(8)|BigInt(t());return new Fe(i)}isEqual(t){return this.data==t.data}toHexString(){return kr(this.data)}toUint8Array(){return sr(this.data)}static fromString(t){return new Fe(Fr(t))}static fromStringOrNull(t){let i=Fe.fromString(t);return i.isZero()?null:i}},V,Br=(V=class{constructor(t){p(this,"__time_duration_micros__");this.__time_duration_micros__=t}get micros(){return this.__time_duration_micros__}get millis(){return Number(this.micros/V.MICROS_PER_MILLIS)}static fromMillis(t){return new V(BigInt(t)*V.MICROS_PER_MILLIS)}},p(V,"MICROS_PER_MILLIS",1000n),V),D,Pr=(D=class{constructor(t){p(this,"__timestamp_micros_since_unix_epoch__");this.__timestamp_micros_since_unix_epoch__=t}get microsSinceUnixEpoch(){return this.__timestamp_micros_since_unix_epoch__}static now(){return D.fromDate(new Date)}static fromDate(t){const i=t.getTime(),s=BigInt(i)*D.MICROS_PER_MILLIS;return new D(s)}toDate(){const i=this.__timestamp_micros_since_unix_epoch__/D.MICROS_PER_MILLIS;if(i>BigInt(Number.MAX_SAFE_INTEGER)||i<BigInt(Number.MIN_SAFE_INTEGER))throw new RangeError("Timestamp is outside of the representable range of JS's Date");return new Date(Number(i))}},p(D,"MICROS_PER_MILLIS",1000n),p(D,"UNIX_EPOCH",new D(0n)),D),xr=class cr{constructor(t){p(this,"data");this.data=typeof t=="string"?Cr(t):t}get __identity__(){return this.data}isEqual(t){return this.toHexString()===t.toHexString()}toHexString(){return Er(this.data)}toUint8Array(){return ar(this.data)}static fromString(t){return new cr(t)}},Ye;(e=>{function t(){return c.createSumType([new S("Interval",c.createU64Type()),new S("Time",c.createU64Type())])}e.getAlgebraicType=t;function i(r){switch(r.tag){case"Interval":return{Interval:r.value};case"Time":return{Time:r.value};default:throw"unreachable"}}e.serialize=i,e.Interval=r=>({tag:"Interval",value:r}),e.Time=r=>({tag:"Time",value:r});function s(r){let a=r.asSumValue();switch(a.tag){case 0:return{tag:"Interval",value:a.value.asBigInt()};case 1:return{tag:"Time",value:a.value.asBigInt()};default:throw"unreachable"}}e.fromValue=s})(Ye||(Ye={}));var Or=Ye,S=class{constructor(e,t){p(this,"name");p(this,"algebraicType");this.name=e,this.algebraicType=t}},Rr=class{constructor(e){p(this,"variants");p(this,"serialize",(e,t)=>{if(this.variants.length==2&&this.variants[0].name==="some"&&this.variants[1].name==="none")t?(e.writeByte(0),this.variants[0].algebraicType.serialize(e,t)):e.writeByte(1);else{let i=t.tag;const s=this.variants.findIndex(r=>r.name===i);if(s<0)throw`Can't serialize a sum type, couldn't find ${t.tag} tag`;e.writeU8(s),this.variants[s].algebraicType.serialize(e,t.value)}});p(this,"deserialize",e=>{let t=e.readU8();if(this.variants.length==2&&this.variants[0].name==="some"&&this.variants[1].name==="none"){if(t===0)return this.variants[0].algebraicType.deserialize(e);if(t===1)return;throw`Can't deserialize an option type, couldn't find ${t} tag`}else{let i=this.variants[t],s=i.algebraicType.deserialize(e);return{tag:i.name,value:s}}});this.variants=e}},o=class{constructor(e,t){p(this,"name");p(this,"algebraicType");this.name=e,this.algebraicType=t}},qr=class{constructor(e){p(this,"elements");p(this,"serialize",(e,t)=>{for(let i of this.elements)i.algebraicType.serialize(e,t[i.name])});p(this,"deserialize",e=>{let t={};if(this.elements.length===1){if(this.elements[0].name==="__time_duration_micros__")return new Br(e.readI64());if(this.elements[0].name==="__timestamp_micros_since_unix_epoch__")return new Pr(e.readI64());if(this.elements[0].name==="__identity__")return new xr(e.readU256());if(this.elements[0].name==="__connection_id__")return new Xe(e.readU128())}for(let i of this.elements)t[i.name]=i.algebraicType.deserialize(e);return t});this.elements=e}isEmpty(){return this.elements.length===0}},Nr=class{constructor(e,t){p(this,"keyType");p(this,"valueType");this.keyType=e,this.valueType=t}},$,re,F,se,C,Te,je,be,Qe,fe,et,c=(se=class{constructor(){h(this,$);h(this,Te);h(this,be);h(this,fe);p(this,"type");p(this,"type_")}get product(){if(this.type!==l.ProductType)throw"product type was requested, but the type is not ProductType";return this.type_}set product(t){y(this,$,re).call(this,l.ProductType,t)}get sum(){if(this.type!==l.SumType)throw"sum type was requested, but the type is not SumType";return this.type_}set sum(t){y(this,$,re).call(this,l.SumType,t)}get array(){if(this.type!==l.ArrayType)throw"array type was requested, but the type is not ArrayType";return this.type_}set array(t){y(this,$,re).call(this,l.ArrayType,t)}get map(){if(this.type!==l.MapType)throw"map type was requested, but the type is not MapType";return this.type_}set map(t){y(this,$,re).call(this,l.MapType,t)}static createProductType(t){return y(this,F,C).call(this,l.ProductType,new qr(t))}static createSumType(t){return y(this,F,C).call(this,l.SumType,new Rr(t))}static createArrayType(t){return y(this,F,C).call(this,l.ArrayType,t)}static createMapType(t,i){return y(this,F,C).call(this,l.MapType,new Nr(t,i))}static createBoolType(){return y(this,F,C).call(this,l.Bool,null)}static createI8Type(){return y(this,F,C).call(this,l.I8,null)}static createU8Type(){return y(this,F,C).call(this,l.U8,null)}static createI16Type(){return y(this,F,C).call(this,l.I16,null)}static createU16Type(){return y(this,F,C).call(this,l.U16,null)}static createI32Type(){return y(this,F,C).call(this,l.I32,null)}static createU32Type(){return y(this,F,C).call(this,l.U32,null)}static createI64Type(){return y(this,F,C).call(this,l.I64,null)}static createU64Type(){return y(this,F,C).call(this,l.U64,null)}static createI128Type(){return y(this,F,C).call(this,l.I128,null)}static createU128Type(){return y(this,F,C).call(this,l.U128,null)}static createI256Type(){return y(this,F,C).call(this,l.I256,null)}static createU256Type(){return y(this,F,C).call(this,l.U256,null)}static createF32Type(){return y(this,F,C).call(this,l.F32,null)}static createF64Type(){return y(this,F,C).call(this,l.F64,null)}static createStringType(){return y(this,F,C).call(this,l.String,null)}static createBytesType(){return this.createArrayType(this.createU8Type())}static createOptionType(t){return this.createSumType([new S("some",t),new S("none",this.createProductType([]))])}static createIdentityType(){return this.createProductType([new o("__identity__",this.createU256Type())])}static createConnectionIdType(){return this.createProductType([new o("__connection_id__",this.createU128Type())])}static createScheduleAtType(){return Or.getAlgebraicType()}static createTimestampType(){return this.createProductType([new o("__timestamp_micros_since_unix_epoch__",this.createI64Type())])}static createTimeDurationType(){return this.createProductType([new o("__time_duration_micros__",this.createI64Type())])}isProductType(){return this.type===l.ProductType}isSumType(){return this.type===l.SumType}isArrayType(){return this.type===l.ArrayType}isMapType(){return this.type===l.MapType}isIdentity(){return y(this,be,Qe).call(this,"__identity__")}isConnectionId(){return y(this,be,Qe).call(this,"__connection_id__")}isScheduleAt(){return this.isSumType()&&this.sum.variants.length===2&&this.sum.variants[0].name==="Interval"&&this.sum.variants[0].algebraicType.type===l.U64&&this.sum.variants[1].name==="Time"&&this.sum.variants[1].algebraicType.type===l.U64}isTimestamp(){return y(this,fe,et).call(this,"__timestamp_micros_since_unix_epoch__")}isTimeDuration(){return y(this,fe,et).call(this,"__time_duration_micros__")}serialize(t,i){switch(this.type){case l.ProductType:this.product.serialize(t,i);break;case l.SumType:this.sum.serialize(t,i);break;case l.ArrayType:if(y(this,Te,je).call(this))t.writeUInt8Array(i);else{const s=this.array;t.writeU32(i.length);for(let r of i)s.serialize(t,r)}break;case l.MapType:throw new Error("not implemented");case l.Bool:t.writeBool(i);break;case l.I8:t.writeI8(i);break;case l.U8:t.writeU8(i);break;case l.I16:t.writeI16(i);break;case l.U16:t.writeU16(i);break;case l.I32:t.writeI32(i);break;case l.U32:t.writeU32(i);break;case l.I64:t.writeI64(i);break;case l.U64:t.writeU64(i);break;case l.I128:t.writeI128(i);break;case l.U128:t.writeU128(i);break;case l.I256:t.writeI256(i);break;case l.U256:t.writeU256(i);break;case l.F32:t.writeF32(i);break;case l.F64:t.writeF64(i);break;case l.String:t.writeString(i);break;default:throw new Error(`not implemented, ${this.type}`)}}deserialize(t){switch(this.type){case l.ProductType:return this.product.deserialize(t);case l.SumType:return this.sum.deserialize(t);case l.ArrayType:if(y(this,Te,je).call(this))return t.readUInt8Array();{const i=this.array,s=t.readU32();let r=[];for(let a=0;a<s;a++)r.push(i.deserialize(t));return r}case l.MapType:throw new Error("not implemented");case l.Bool:return t.readBool();case l.I8:return t.readI8();case l.U8:return t.readU8();case l.I16:return t.readI16();case l.U16:return t.readU16();case l.I32:return t.readI32();case l.U32:return t.readU32();case l.I64:return t.readI64();case l.U64:return t.readU64();case l.I128:return t.readI128();case l.U128:return t.readU128();case l.U256:return t.readU256();case l.F32:return t.readF32();case l.F64:return t.readF64();case l.String:return t.readString();default:throw new Error(`not implemented, ${this.type}`)}}},$=new WeakSet,re=function(t,i){this.type_=i,this.type=i===void 0?l.None:t},F=new WeakSet,C=function(t,i){var r;let s=new se;return y(r=s,$,re).call(r,t,i),s},Te=new WeakSet,je=function(){return this.isArrayType()&&this.array.type==l.U8},be=new WeakSet,Qe=function(t){return this.isProductType()&&this.product.elements.length===1&&(this.product.elements[0].algebraicType.type==l.U128||this.product.elements[0].algebraicType.type==l.U256)&&this.product.elements[0].name===t},fe=new WeakSet,et=function(t){return this.isProductType()&&this.product.elements.length===1&&this.product.elements[0].algebraicType.type===l.I64&&this.product.elements[0].name===t},h(se,F),se);(e=>{(t=>{t.SumType="SumType",t.ProductType="ProductType",t.ArrayType="ArrayType",t.MapType="MapType",t.Bool="Bool",t.I8="I8",t.U8="U8",t.I16="I16",t.U16="U16",t.I32="I32",t.U32="U32",t.I64="I64",t.U64="U64",t.I128="I128",t.U128="U128",t.I256="I256",t.U256="U256",t.F32="F32",t.F64="F64",t.String="String",t.None="None"})(e.Type||(e.Type={}))})(c||(c={}));var l=c.Type;function Dr(e,t){const i=new ne(t);return e.deserialize(i)}var tt;(e=>{e.FixedSize=r=>({tag:"FixedSize",value:r}),e.RowOffsets=r=>({tag:"RowOffsets",value:r});function t(){return c.createSumType([new S("FixedSize",c.createU16Type()),new S("RowOffsets",c.createArrayType(c.createU64Type()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(tt||(tt={}));var he;(e=>{function t(){return c.createProductType([new o("sizeHint",tt.getTypeScriptAlgebraicType()),new o("rowsData",c.createArrayType(c.createU8Type()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(he||(he={}));var rt;(e=>{function t(){return c.createProductType([new o("reducer",c.createStringType()),new o("args",c.createArrayType(c.createU8Type())),new o("requestId",c.createU32Type()),new o("flags",c.createU8Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(rt||(rt={}));var it;(e=>{function t(){return c.createProductType([new o("queryStrings",c.createArrayType(c.createStringType())),new o("requestId",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(it||(it={}));var nt;(e=>{function t(){return c.createProductType([new o("messageId",c.createArrayType(c.createU8Type())),new o("queryString",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(nt||(nt={}));var L;(e=>{function t(){return c.createProductType([new o("id",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(L||(L={}));var st;(e=>{function t(){return c.createProductType([new o("query",c.createStringType()),new o("requestId",c.createU32Type()),new o("queryId",L.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(st||(st={}));var at;(e=>{function t(){return c.createProductType([new o("queryStrings",c.createArrayType(c.createStringType())),new o("requestId",c.createU32Type()),new o("queryId",L.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(at||(at={}));var ct;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("queryId",L.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ct||(ct={}));var ot;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("queryId",L.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ot||(ot={}));var ie;(e=>{e.CallReducer=r=>({tag:"CallReducer",value:r}),e.Subscribe=r=>({tag:"Subscribe",value:r}),e.OneOffQuery=r=>({tag:"OneOffQuery",value:r}),e.SubscribeSingle=r=>({tag:"SubscribeSingle",value:r}),e.SubscribeMulti=r=>({tag:"SubscribeMulti",value:r}),e.Unsubscribe=r=>({tag:"Unsubscribe",value:r}),e.UnsubscribeMulti=r=>({tag:"UnsubscribeMulti",value:r});function t(){return c.createSumType([new S("CallReducer",rt.getTypeScriptAlgebraicType()),new S("Subscribe",it.getTypeScriptAlgebraicType()),new S("OneOffQuery",nt.getTypeScriptAlgebraicType()),new S("SubscribeSingle",st.getTypeScriptAlgebraicType()),new S("SubscribeMulti",at.getTypeScriptAlgebraicType()),new S("Unsubscribe",ct.getTypeScriptAlgebraicType()),new S("UnsubscribeMulti",ot.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ie||(ie={}));var Ee;(e=>{function t(){return c.createProductType([new o("deletes",he.getTypeScriptAlgebraicType()),new o("inserts",he.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Ee||(Ee={}));var pt;(e=>{e.Uncompressed=r=>({tag:"Uncompressed",value:r}),e.Brotli=r=>({tag:"Brotli",value:r}),e.Gzip=r=>({tag:"Gzip",value:r});function t(){return c.createSumType([new S("Uncompressed",Ee.getTypeScriptAlgebraicType()),new S("Brotli",c.createArrayType(c.createU8Type())),new S("Gzip",c.createArrayType(c.createU8Type()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(pt||(pt={}));var Be;(e=>{function t(){return c.createProductType([new o("tableId",c.createU32Type()),new o("tableName",c.createStringType()),new o("numRows",c.createU64Type()),new o("updates",c.createArrayType(pt.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Be||(Be={}));var ee;(e=>{function t(){return c.createProductType([new o("tables",c.createArrayType(Be.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ee||(ee={}));var lt;(e=>{function t(){return c.createProductType([new o("quanta",c.createU128Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(lt||(lt={}));var ut;(e=>{function t(){return c.createProductType([new o("identity",c.createIdentityType()),new o("token",c.createStringType()),new o("connectionId",c.createConnectionIdType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ut||(ut={}));var yt;(e=>{function t(){return c.createProductType([new o("databaseUpdate",ee.getTypeScriptAlgebraicType()),new o("requestId",c.createU32Type()),new o("totalHostExecutionDuration",c.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(yt||(yt={}));var dt;(e=>{function t(){return c.createProductType([new o("tableName",c.createStringType()),new o("rows",he.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(dt||(dt={}));var gt;(e=>{function t(){return c.createProductType([new o("messageId",c.createArrayType(c.createU8Type())),new o("error",c.createOptionType(c.createStringType())),new o("tables",c.createArrayType(dt.getTypeScriptAlgebraicType())),new o("totalHostExecutionDuration",c.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(gt||(gt={}));var ht;(e=>{function t(){return c.createProductType([new o("reducerName",c.createStringType()),new o("reducerId",c.createU32Type()),new o("args",c.createArrayType(c.createU8Type())),new o("requestId",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ht||(ht={}));var Tt;(e=>{e.Committed=r=>({tag:"Committed",value:r}),e.Failed=r=>({tag:"Failed",value:r}),e.OutOfEnergy={tag:"OutOfEnergy"};function t(){return c.createSumType([new S("Committed",ee.getTypeScriptAlgebraicType()),new S("Failed",c.createStringType()),new S("OutOfEnergy",c.createProductType([]))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Tt||(Tt={}));var bt;(e=>{function t(){return c.createProductType([new o("status",Tt.getTypeScriptAlgebraicType()),new o("timestamp",c.createTimestampType()),new o("callerIdentity",c.createIdentityType()),new o("callerConnectionId",c.createConnectionIdType()),new o("reducerCall",ht.getTypeScriptAlgebraicType()),new o("energyQuantaUsed",lt.getTypeScriptAlgebraicType()),new o("totalHostExecutionDuration",c.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(bt||(bt={}));var ft;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("update",ee.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ft||(ft={}));var Pe;(e=>{function t(){return c.createProductType([new o("tableId",c.createU32Type()),new o("tableName",c.createStringType()),new o("tableRows",Be.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Pe||(Pe={}));var mt;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("totalHostExecutionDurationMicros",c.createU64Type()),new o("queryId",L.getTypeScriptAlgebraicType()),new o("rows",Pe.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(mt||(mt={}));var wt;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("totalHostExecutionDurationMicros",c.createU64Type()),new o("queryId",L.getTypeScriptAlgebraicType()),new o("rows",Pe.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(wt||(wt={}));var St;(e=>{function t(){return c.createProductType([new o("totalHostExecutionDurationMicros",c.createU64Type()),new o("requestId",c.createOptionType(c.createU32Type())),new o("queryId",c.createOptionType(c.createU32Type())),new o("tableId",c.createOptionType(c.createU32Type())),new o("error",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(St||(St={}));var At;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("totalHostExecutionDurationMicros",c.createU64Type()),new o("queryId",L.getTypeScriptAlgebraicType()),new o("update",ee.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(At||(At={}));var zt;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("totalHostExecutionDurationMicros",c.createU64Type()),new o("queryId",L.getTypeScriptAlgebraicType()),new o("update",ee.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(zt||(zt={}));var It;(e=>{e.InitialSubscription=r=>({tag:"InitialSubscription",value:r}),e.TransactionUpdate=r=>({tag:"TransactionUpdate",value:r}),e.TransactionUpdateLight=r=>({tag:"TransactionUpdateLight",value:r}),e.IdentityToken=r=>({tag:"IdentityToken",value:r}),e.OneOffQueryResponse=r=>({tag:"OneOffQueryResponse",value:r}),e.SubscribeApplied=r=>({tag:"SubscribeApplied",value:r}),e.UnsubscribeApplied=r=>({tag:"UnsubscribeApplied",value:r}),e.SubscriptionError=r=>({tag:"SubscriptionError",value:r}),e.SubscribeMultiApplied=r=>({tag:"SubscribeMultiApplied",value:r}),e.UnsubscribeMultiApplied=r=>({tag:"UnsubscribeMultiApplied",value:r});function t(){return c.createSumType([new S("InitialSubscription",yt.getTypeScriptAlgebraicType()),new S("TransactionUpdate",bt.getTypeScriptAlgebraicType()),new S("TransactionUpdateLight",ft.getTypeScriptAlgebraicType()),new S("IdentityToken",ut.getTypeScriptAlgebraicType()),new S("OneOffQueryResponse",gt.getTypeScriptAlgebraicType()),new S("SubscribeApplied",mt.getTypeScriptAlgebraicType()),new S("UnsubscribeApplied",wt.getTypeScriptAlgebraicType()),new S("SubscriptionError",St.getTypeScriptAlgebraicType()),new S("SubscribeMultiApplied",At.getTypeScriptAlgebraicType()),new S("UnsubscribeMultiApplied",zt.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(It||(It={}));var X,Yt,Ke=(Yt=class{constructor(){h(this,X,new Map)}on(e,t){let i=n(this,X).get(e);i||(i=new Set,n(this,X).set(e,i)),i.add(t)}off(e,t){let i=n(this,X).get(e);!i||i.delete(t)}emit(e,...t){let i=n(this,X).get(e);if(!!i)for(let s of i)s(...t)}},X=new WeakMap,Yt),N,Y,de,jt,Jt=(jt=class{constructor(){h(this,Y);h(this,N,[])}set(e,t){const i=n(this,N).findIndex(({key:s})=>y(this,Y,de).call(this,s,e));i>-1?n(this,N)[i].value=t:n(this,N).push({key:e,value:t})}get(e){const t=n(this,N).find(({key:i})=>y(this,Y,de).call(this,i,e));return t?t.value:void 0}delete(e){const t=n(this,N).findIndex(({key:i})=>y(this,Y,de).call(this,i,e));return t>-1?(n(this,N).splice(t,1),!0):!1}has(e){return n(this,N).some(({key:t})=>y(this,Y,de).call(this,t,e))}values(){return n(this,N).map(e=>e.value)}entries(){return n(this,N)}[Symbol.iterator](){let e=0;const t=n(this,N);return{next(){return e<t.length?{value:t[e++],done:!1}:{value:null,done:!0}}}}},N=new WeakMap,Y=new WeakSet,de=function(e,t){return e&&typeof e=="object"&&"isEqual"in e?e.isEqual(t):e===t},jt),Mr={component:"\u{1F4E6}",info:"\u2139\uFE0F",warn:"\u26A0\uFE0F",error:"\u274C",debug:"\u{1F41B}"},Lr={component:"color: #fff; background-color: #8D6FDD; padding: 2px 5px; border-radius: 3px;",info:"color: #fff; background-color: #007bff; padding: 2px 5px; border-radius: 3px;",warn:"color: #fff; background-color: #ffc107; padding: 2px 5px; border-radius: 3px;",error:"color: #fff; background-color: #dc3545; padding: 2px 5px; border-radius: 3px;",debug:"color: #fff; background-color: #28a745; padding: 2px 5px; border-radius: 3px;"},Hr={component:"color: #8D6FDD;",info:"color: #007bff;",warn:"color: #ffc107;",error:"color: #dc3545;",debug:"color: #28a745;"},Z=(e,t)=>{console.log(`%c${Mr[e]} ${e.toUpperCase()}%c ${t}`,Lr[e],Hr[e])},$r=class{constructor(e){p(this,"rows");p(this,"tableTypeInfo");p(this,"emitter");p(this,"applyOperations",(e,t)=>{const i=[];if(this.tableTypeInfo.primaryKey!==void 0){const s=this.tableTypeInfo.primaryKey,r=new Jt,a=new Jt;for(const u of e)if(u.type==="insert"){const[g,T]=r.get(u.row[s])||[u,0];r.set(u.row[s],[u,T+1])}else{const[g,T]=a.get(u.row[s])||[u,0];a.set(u.row[s],[u,T+1])}for(const{key:u,value:[g,T]}of r){const m=a.get(u);if(m){const[w,I]=m,U=T-I,R=this.update(t,g,w,U);R&&i.push(R),a.delete(u)}else{const w=this.insert(t,g,T);w&&i.push(w)}}for(const[u,g]of a.values()){const T=this.delete(t,u,g);T&&i.push(T)}}else for(const s of e)if(s.type==="insert"){const r=this.insert(t,s);r&&i.push(r)}else{const r=this.delete(t,s);r&&i.push(r)}return i});p(this,"update",(e,t,i,s=0)=>{const[r,a]=this.rows.get(i.rowId)||[i.row,0],u=Math.max(1,a+s);return this.rows.delete(i.rowId),this.rows.set(t.rowId,[t.row,u]),a===0?(Z("error","Updating a row that was not present in the cache"),{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,t.row)}}):(a+s<=0&&Z("error","Negative reference count for row"),{type:"update",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("update",e,r,t.row)}})});p(this,"insert",(e,t,i=1)=>{const[s,r]=this.rows.get(t.rowId)||[t.row,0];if(this.rows.set(t.rowId,[t.row,r+i]),r===0)return{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,t.row)}}});p(this,"delete",(e,t,i=1)=>{const[s,r]=this.rows.get(t.rowId)||[t.row,0];if(r===0){Z("warn","Deleting a row that was not present in the cache");return}if(r<=i)return this.rows.delete(t.rowId),{type:"delete",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("delete",e,t.row)}};this.rows.set(t.rowId,[t.row,r-i])});p(this,"onInsert",e=>{this.emitter.on("insert",e)});p(this,"onDelete",e=>{this.emitter.on("delete",e)});p(this,"onUpdate",e=>{this.emitter.on("update",e)});p(this,"removeOnInsert",e=>{this.emitter.off("insert",e)});p(this,"removeOnDelete",e=>{this.emitter.off("delete",e)});p(this,"removeOnUpdate",e=>{this.emitter.off("update",e)});this.tableTypeInfo=e,this.rows=new Map,this.emitter=new Ke}count(){return this.rows.size}iter(){return Array.from(this.rows.values()).map(([e])=>e)}},Wr=class{constructor(){p(this,"tables");this.tables=new Map}getTable(e){const t=this.tables.get(e);if(!t)throw console.error("The table has not been registered for this client. Please register the table before using it. If you have registered global tables using the SpacetimeDBClient.registerTables() or `registerTable()` method, please make sure that is executed first!"),new Error(`Table ${e} does not exist`);return t}getOrCreateTable(e){let t;return this.tables.has(e.tableName)?t=this.tables.get(e.tableName):(t=new $r(e),this.tables.set(e.tableName,t)),t}};async function or(e,t,i=128*1024){let s=0;const r=new ReadableStream({pull(R){if(s<e.length){const v=e.subarray(s,Math.min(s+i,e.length));R.enqueue(v),s+=i}else R.close()}}),a=new DecompressionStream(t),g=r.pipeThrough(a).getReader(),T=[];let m=0,w;for(;!(w=await g.read()).done;)T.push(w.value),m+=w.value.length;const I=new Uint8Array(m);let U=0;for(const R of T)I.set(R,U),U+=R.length;return I}var ae,Oe,pr,Re,lr,me,Ut,we,Gr=(we=class{constructor(t){h(this,Oe);h(this,Re);h(this,me);p(this,"onclose");p(this,"onopen");p(this,"onmessage");p(this,"onerror");h(this,ae,void 0);this.onmessage=void 0,this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,t.onmessage=y(this,Oe,pr).bind(this),t.onerror=y(this,me,Ut).bind(this),t.onclose=y(this,me,Ut).bind(this),t.onopen=y(this,Re,lr).bind(this),t.binaryType="arraybuffer",d(this,ae,t)}send(t){n(this,ae).send(t)}close(){n(this,ae).close()}static async createWebSocketFn({url:t,wsProtocol:i,authToken:s,compression:r,lightMode:a}){const u=new Headers;let g;if(g=WebSocket,s){u.set("Authorization",`Bearer ${s}`);const m=new URL("/v1/identity/websocket-token",t);m.protocol=t.protocol==="wss:"?"https:":"http:";const w=await fetch(m,{method:"POST",headers:u});if(w.ok){const{token:I}=await w.json();t.searchParams.set("token",I)}}t.searchParams.set("compression",r==="gzip"?"Gzip":"None"),a&&t.searchParams.set("light","true");const T=new g(t,i);return new we(T)}},ae=new WeakMap,Oe=new WeakSet,pr=async function(t){const i=new Uint8Array(t.data);let s;if(i[0]===0)s=i.slice(1);else{if(i[0]===1)throw new Error("Brotli Compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");if(i[0]===2)s=await or(i.slice(1),"gzip");else throw new Error("Unexpected Compression Algorithm. Please use `gzip` or `none`")}this.onmessage?.({data:s})},Re=new WeakSet,lr=function(t){this.onopen?.(t)},me=new WeakSet,Ut=function(t){this.onerror?.(t)},we),ce,oe,qe,Se,j,Ae,ze,pe,Qt,Kr=(Qt=class{constructor(e,t){h(this,ce,void 0);h(this,oe,void 0);h(this,qe,void 0);h(this,Se,void 0);h(this,j,new Ke);h(this,Ae,"gzip");h(this,ze,!1);h(this,pe,void 0);this.remoteModule=e,this.dbConnectionConstructor=t,d(this,pe,Gr.createWebSocketFn)}withUri(e){return d(this,ce,new URL(e)),this}withModuleName(e){return d(this,oe,e),this}withToken(e){return d(this,Se,e),this}withWSFn(e){return d(this,pe,e),this}withCompression(e){return d(this,Ae,e),this}withLightMode(e){return d(this,ze,e),this}onConnect(e){return n(this,j).on("connect",e),this}onConnectError(e){return n(this,j).on("connectError",e),this}onDisconnect(e){return n(this,j).on("disconnect",e),this}build(){if(!n(this,ce))throw new Error("URI is required to connect to SpacetimeDB");if(!n(this,oe))throw new Error("Database name or address is required to connect to SpacetimeDB");return this.dbConnectionConstructor(new yr({uri:n(this,ce),nameOrAddress:n(this,oe),identity:n(this,qe),token:n(this,Se),emitter:n(this,j),compression:n(this,Ae),lightMode:n(this,ze),createWSFn:n(this,pe),remoteModule:this.remoteModule}))}},ce=new WeakMap,oe=new WeakMap,qe=new WeakMap,Se=new WeakMap,j=new WeakMap,Ae=new WeakMap,ze=new WeakMap,pe=new WeakMap,Qt),Ie,Ue,er,ur=(er=class{constructor(e){h(this,Ie,void 0);h(this,Ue,void 0);this.db=e}onApplied(e){return d(this,Ie,e),this}onError(e){return d(this,Ue,e),this}subscribe(e){const t=Array.isArray(e)?e:[e];if(t.length===0)throw new Error("Subscriptions must have at least one query");return new Jr(this.db,t,n(this,Ie),n(this,Ue))}subscribeToAllTables(){this.subscribe("SELECT * FROM *")}},Ie=new WeakMap,Ue=new WeakMap,er),Vr=class{constructor(){p(this,"subscriptions",new Map)}},le,Q,W,G,K,tr,Jr=(tr=class{constructor(e,t,i,s){h(this,le,void 0);h(this,Q,!1);h(this,W,!1);h(this,G,!1);h(this,K,new Ke);this.db=e,n(this,K).on("applied",r=>{d(this,G,!0),i&&i(r)}),n(this,K).on("error",(r,a)=>{d(this,G,!1),d(this,W,!0),s&&s(r,a)}),d(this,le,this.db.registerSubscription(this,n(this,K),t))}unsubscribe(){if(n(this,Q))throw new Error("Unsubscribe has already been called");d(this,Q,!0),this.db.unregisterSubscription(n(this,le)),n(this,K).on("end",e=>{d(this,W,!0),d(this,G,!1)})}unsubscribeThen(e){if(n(this,W))throw new Error("Subscription has already ended");if(n(this,Q))throw new Error("Unsubscribe has already been called");d(this,Q,!0),this.db.unregisterSubscription(n(this,le)),n(this,K).on("end",t=>{d(this,W,!0),d(this,G,!1),e(t)})}isEnded(){return n(this,W)}isActive(){return n(this,G)}},le=new WeakMap,Q=new WeakMap,W=new WeakMap,G=new WeakMap,K=new WeakMap,tr);function Zr(e){switch(e){case"FullUpdate":return 0;case"NoSuccessNotify":return 1}}var ve,O,ue,Ne,P,_e,M,De,Me,dr,ye,Ce,Le,gr,H,J,He,hr,$e,Tr,We,br,Mt,Xr,Lt,Yr,Ht,jr,$t,Qr,Wt,ei,Gt,ti,Kt,ri,rr,yr=(rr=class{constructor({uri:e,nameOrAddress:t,identity:i,token:s,emitter:r,remoteModule:a,createWSFn:u,compression:g,lightMode:T}){h(this,Me);h(this,ye);h(this,Le);h(this,H);h(this,He);h(this,$e);h(this,We);h(this,Mt);h(this,Lt);h(this,Ht);h(this,$t);h(this,Wt);h(this,Gt);h(this,Kt);p(this,"isActive",!1);p(this,"identity");p(this,"token");p(this,"db");p(this,"reducers");p(this,"setReducerFlags");p(this,"connectionId",Xe.random());h(this,ve,0);h(this,O,void 0);h(this,ue,new Ke);h(this,Ne,void 0);h(this,P,void 0);h(this,_e,Promise.resolve());h(this,M,new Vr);p(this,"clientCache");p(this,"ws");p(this,"wsPromise");h(this,De,()=>{const e=n(this,ve);return d(this,ve,n(this,ve)+1),e});p(this,"subscriptionBuilder",()=>new ur(this));Z("info","Connecting to SpacetimeDB WS...");let m=new URL(`v1/database/${t}/subscribe`,e);/^wss?:/.test(e.protocol)||(m.protocol="ws:"),this.identity=i,this.token=s,d(this,P,a),d(this,O,r);let w=this.connectionId.toHexString();m.searchParams.set("connection_id",w),this.clientCache=new Wr,this.db=n(this,P).dbViewConstructor(this),this.setReducerFlags=n(this,P).setReducerFlagsConstructor(),this.reducers=n(this,P).reducersConstructor(this,this.setReducerFlags),this.wsPromise=u({url:m,wsProtocol:"v1.bsatn.spacetimedb",authToken:s,compression:g,lightMode:T}).then(I=>(this.ws=I,this.ws.onclose=()=>{n(this,O).emit("disconnect",this)},this.ws.onerror=U=>{n(this,O).emit("connectError",this,U)},this.ws.onopen=y(this,Le,gr).bind(this),this.ws.onmessage=y(this,$e,Tr).bind(this),I)).catch(I=>{throw Z("error","Error connecting to SpacetimeDB WS"),y(this,We,br).call(this,"connectError",I),I})}registerSubscription(e,t,i){const s=n(this,De).call(this);return n(this,M).subscriptions.set(s,{handle:e,emitter:t}),y(this,ye,Ce).call(this,ie.SubscribeMulti({queryStrings:i,queryId:{id:s},requestId:0})),s}unregisterSubscription(e){y(this,ye,Ce).call(this,ie.UnsubscribeMulti({queryId:{id:e},requestId:0}))}callReducer(e,t,i){const s=ie.CallReducer({reducer:e,args:t,requestId:0,flags:Zr(i)});y(this,ye,Ce).call(this,s)}disconnect(){this.wsPromise.then(e=>{e.close()})}onReducer(e,t){n(this,ue).on(e,t)}offReducer(e,t){n(this,ue).off(e,t)}},ve=new WeakMap,O=new WeakMap,ue=new WeakMap,Ne=new WeakMap,P=new WeakMap,_e=new WeakMap,M=new WeakMap,De=new WeakMap,Me=new WeakSet,dr=async function(e){const t=(r,a,u)=>{const g=u.rowsData,T=new ne(g),m=[],w=n(this,P).tables[a].rowType;for(;T.offset<g.length+g.byteOffset;){const I=w.deserialize(T),U=JSON.stringify(I,(R,v)=>typeof v=="bigint"?v.toString():v);m.push({type:r,rowId:U,row:I})}return m},i=async r=>{const a=r.tableName;let u=[];for(const g of r.updates){let T;if(g.tag==="Gzip"){const m=await or(g.value,"gzip");T=Ee.deserialize(new ne(m))}else{if(g.tag==="Brotli")throw new Error("Brotli compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");T=g.value}u=u.concat(t("insert",a,T.inserts)),u=u.concat(t("delete",a,T.deletes))}return{tableName:a,operations:u}},s=async r=>{const a=[];for(const u of r.tables)a.push(await i(u));return a};switch(e.tag){case"InitialSubscription":{const r=e.value.databaseUpdate;return{tag:"InitialSubscription",tableUpdates:await s(r)}}case"TransactionUpdateLight":{const r=e.value.update;return{tag:"TransactionUpdateLight",tableUpdates:await s(r)}}case"TransactionUpdate":{const r=e.value,a=r.callerIdentity,u=Xe.nullIfZero(r.callerConnectionId),g=r.reducerCall.reducerName,T=r.reducerCall.args,m=r.energyQuantaUsed;let w,I="";switch(r.status.tag){case"Committed":w=await s(r.status.value);break;case"Failed":w=[],I=r.status.value;break;case"OutOfEnergy":w=[];break}if(g==="<none>"){console.error(`Received an error from the database: ${I}`);return}let U;return g!==""&&(U={reducerName:g,args:T}),{tag:"TransactionUpdate",tableUpdates:w,identity:a,connectionId:u,reducerInfo:U,status:r.status,energyConsumed:m.quanta,message:I,timestamp:r.timestamp}}case"IdentityToken":return{tag:"IdentityToken",identity:e.value.identity,token:e.value.token,connectionId:e.value.connectionId};case"OneOffQueryResponse":throw new Error(`TypeScript SDK never sends one-off queries, but got OneOffQueryResponse ${e}`);case"SubscribeMultiApplied":{const r=await s(e.value.update);return{tag:"SubscribeApplied",queryId:e.value.queryId.id,tableUpdates:r}}case"UnsubscribeMultiApplied":{const r=await s(e.value.update);return{tag:"UnsubscribeApplied",queryId:e.value.queryId.id,tableUpdates:r}}case"SubscriptionError":return{tag:"SubscriptionError",queryId:e.value.queryId,error:e.value.error}}},ye=new WeakSet,Ce=function(e){this.wsPromise.then(t=>{const i=new Ge(1024);ie.serialize(i,e);const s=i.getBuffer();t.send(s)})},Le=new WeakSet,gr=function(){this.isActive=!0},H=new WeakSet,J=function(e,t){const i=[];for(let s of e){const r=s.tableName,a=n(this,P).tables[r],u=this.clientCache.getOrCreateTable(a);i.push(...u.applyOperations(s.operations,t))}return i},He=new WeakSet,hr=async function(e){var s;const t=Dr(It,e),i=await y(this,Me,dr).call(this,t);if(!!i)switch(i.tag){case"InitialSubscription":{let r={tag:"SubscribeApplied"};const a=n(this,P).eventContextConstructor(this,r),{event:u,...g}=a,T=y(this,H,J).call(this,i.tableUpdates,a);n(this,O)&&((s=n(this,Ne))==null||s.call(this,g));for(const m of T)m.cb();break}case"TransactionUpdateLight":{let r={tag:"UnknownTransaction"};const a=n(this,P).eventContextConstructor(this,r),u=y(this,H,J).call(this,i.tableUpdates,a);for(const g of u)g.cb();break}case"TransactionUpdate":{let r=i.reducerInfo,a=!1,u,g;if(!r)a=!0;else{g=n(this,P).reducers[r.reducerName];try{const v=new ne(r.args);u=g.argsType.deserialize(v)}catch{console.debug("Failed to deserialize reducer arguments"),a=!0}}if(a){const v={tag:"UnknownTransaction"},_=n(this,P).eventContextConstructor(this,v),B=y(this,H,J).call(this,i.tableUpdates,_);for(const Ve of B)Ve.cb();return}r=r,g=g;const T={callerIdentity:i.identity,status:i.status,callerConnectionId:i.connectionId,timestamp:i.timestamp,energyConsumed:i.energyConsumed,reducer:{name:r.reducerName,args:u}},m={tag:"Reducer",value:T},w=n(this,P).eventContextConstructor(this,m),I={...w,event:T},U=y(this,H,J).call(this,i.tableUpdates,w),R=[];g.argsType.product.elements.forEach((v,_)=>{R.push(u[v.name])}),n(this,ue).emit(r.reducerName,I,...R);for(const v of U)v.cb();break}case"IdentityToken":{this.identity=i.identity,!this.token&&i.token&&(this.token=i.token),this.connectionId=i.connectionId,n(this,O).emit("connect",this,this.identity,this.token);break}case"SubscribeApplied":{const r=n(this,M).subscriptions.get(i.queryId);if(r===void 0){Z("error",`Received SubscribeApplied for unknown queryId ${i.queryId}.`);break}const a={tag:"SubscribeApplied"},u=n(this,P).eventContextConstructor(this,a),{event:g,...T}=u,m=y(this,H,J).call(this,i.tableUpdates,u);r?.emitter.emit("applied",T);for(const w of m)w.cb();break}case"UnsubscribeApplied":{const r=n(this,M).subscriptions.get(i.queryId);if(r===void 0){Z("error",`Received UnsubscribeApplied for unknown queryId ${i.queryId}.`);break}const a={tag:"UnsubscribeApplied"},u=n(this,P).eventContextConstructor(this,a),{event:g,...T}=u,m=y(this,H,J).call(this,i.tableUpdates,u);r?.emitter.emit("end",T),n(this,M).subscriptions.delete(i.queryId);for(const w of m)w.cb();break}case"SubscriptionError":{const r=Error(i.error),a={tag:"Error",value:r},g={...n(this,P).eventContextConstructor(this,a),event:r};i.queryId!==void 0?(n(this,M).subscriptions.get(i.queryId)?.emitter.emit("error",g,r),n(this,M).subscriptions.delete(i.queryId)):(console.error("Received an error message without a queryId: ",r),n(this,M).subscriptions.forEach(({emitter:T})=>{T.emit("error",g,r)}))}}},$e=new WeakSet,Tr=function(e){d(this,_e,n(this,_e).then(()=>y(this,He,hr).call(this,e.data)))},We=new WeakSet,br=function(e,t){n(this,O).on(e,t)},Mt=new WeakSet,Xr=function(e,t){n(this,O).off(e,t)},Lt=new WeakSet,Yr=function(e){n(this,O).on("connect",e)},Ht=new WeakSet,jr=function(e){n(this,O).on("disconnect",e)},$t=new WeakSet,Qr=function(e){n(this,O).on("connectError",e)},Wt=new WeakSet,ei=function(e){n(this,O).off("connect",e)},Gt=new WeakSet,ti=function(e){n(this,O).off("disconnect",e)},Kt=new WeakSet,ri=function(e){n(this,O).off("connectError",e)},rr),vt;(e=>{function t(){return c.createProductType([])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(vt||(vt={}));var _t;(e=>{function t(){return c.createProductType([])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(_t||(_t={}));var Ft;(e=>{function t(){return c.createProductType([])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Ft||(Ft={}));var Ct;(e=>{function t(){return c.createProductType([])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Ct||(Ct={}));var kt;(e=>{function t(){return c.createProductType([])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(kt||(kt={}));var Et;(e=>{function t(){return c.createProductType([])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Et||(Et={}));var Bt;(e=>{function t(){return c.createProductType([])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Bt||(Bt={}));var xe;(e=>{function t(){return c.createProductType([new o("name",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(xe||(xe={}));class ii{constructor(t){p(this,"tableCache");p(this,"id",{find:t=>{for(let i of this.tableCache.iter())if(ke(i.id,t))return i}});p(this,"onInsert",t=>this.tableCache.onInsert(t));p(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));p(this,"onDelete",t=>this.tableCache.onDelete(t));p(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));p(this,"onUpdate",t=>this.tableCache.onUpdate(t));p(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class ni{constructor(t){p(this,"tableCache");p(this,"id",{find:t=>{for(let i of this.tableCache.iter())if(ke(i.id,t))return i}});p(this,"name",{find:t=>{for(let i of this.tableCache.iter())if(ke(i.name,t))return i}});p(this,"onInsert",t=>this.tableCache.onInsert(t));p(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));p(this,"onDelete",t=>this.tableCache.onDelete(t));p(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));p(this,"onUpdate",t=>this.tableCache.onUpdate(t));p(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}var Pt;(e=>{e.Dublicate={tag:"Dublicate"},e.Levelup={tag:"Levelup"},e.Dead={tag:"Dead"},e.Stay={tag:"Stay"};function t(){return c.createSumType([new S("Dublicate",c.createProductType([])),new S("Levelup",c.createProductType([])),new S("Dead",c.createProductType([])),new S("Stay",c.createProductType([]))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Pt||(Pt={}));var xt;(e=>{function t(){return c.createProductType([new o("animal",c.createU32Type()),new o("action",Pt.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(xt||(xt={}));var Ot;(e=>{function t(){return c.createProductType([new o("id",c.createIdentityType()),new o("secretSeed",c.createU128Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Ot||(Ot={}));var Rt;(e=>{function t(){return c.createProductType([new o("id",c.createIdentityType()),new o("name",c.createStringType()),new o("highscore",c.createU32Type()),new o("highscoreState",c.createArrayType(c.createU32Type())),new o("bank",c.createU32Type()),new o("gameState",c.createArrayType(c.createU32Type())),new o("lastActionResult",c.createArrayType(xt.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Rt||(Rt={}));const qt={tables:{game_state:{tableName:"game_state",rowType:Ot.getTypeScriptAlgebraicType(),primaryKey:"id"},person:{tableName:"person",rowType:Rt.getTypeScriptAlgebraicType(),primaryKey:"id"}},reducers:{create_person:{reducerName:"create_person",argsType:vt.getTypeScriptAlgebraicType()},identity_connected:{reducerName:"identity_connected",argsType:_t.getTypeScriptAlgebraicType()},identity_disconnected:{reducerName:"identity_disconnected",argsType:Ft.getTypeScriptAlgebraicType()},play_green:{reducerName:"play_green",argsType:Ct.getTypeScriptAlgebraicType()},play_red:{reducerName:"play_red",argsType:kt.getTypeScriptAlgebraicType()},reset_bank:{reducerName:"reset_bank",argsType:Et.getTypeScriptAlgebraicType()},sell_game_worth:{reducerName:"sell_game_worth",argsType:Bt.getTypeScriptAlgebraicType()},set_person_name:{reducerName:"set_person_name",argsType:xe.getTypeScriptAlgebraicType()}},eventContextConstructor:(e,t)=>({...e,event:t}),dbViewConstructor:e=>new ci(e),reducersConstructor:(e,t)=>new si(e,t),setReducerFlagsConstructor:()=>new ai};class si{constructor(t,i){this.connection=t,this.setCallReducerFlags=i}createPerson(){this.connection.callReducer("create_person",new Uint8Array(0),this.setCallReducerFlags.createPersonFlags)}onCreatePerson(t){this.connection.onReducer("create_person",t)}removeOnCreatePerson(t){this.connection.offReducer("create_person",t)}onIdentityConnected(t){this.connection.onReducer("identity_connected",t)}removeOnIdentityConnected(t){this.connection.offReducer("identity_connected",t)}onIdentityDisconnected(t){this.connection.onReducer("identity_disconnected",t)}removeOnIdentityDisconnected(t){this.connection.offReducer("identity_disconnected",t)}playGreen(){this.connection.callReducer("play_green",new Uint8Array(0),this.setCallReducerFlags.playGreenFlags)}onPlayGreen(t){this.connection.onReducer("play_green",t)}removeOnPlayGreen(t){this.connection.offReducer("play_green",t)}playRed(){this.connection.callReducer("play_red",new Uint8Array(0),this.setCallReducerFlags.playRedFlags)}onPlayRed(t){this.connection.onReducer("play_red",t)}removeOnPlayRed(t){this.connection.offReducer("play_red",t)}resetBank(){this.connection.callReducer("reset_bank",new Uint8Array(0),this.setCallReducerFlags.resetBankFlags)}onResetBank(t){this.connection.onReducer("reset_bank",t)}removeOnResetBank(t){this.connection.offReducer("reset_bank",t)}sellGameWorth(){this.connection.callReducer("sell_game_worth",new Uint8Array(0),this.setCallReducerFlags.sellGameWorthFlags)}onSellGameWorth(t){this.connection.onReducer("sell_game_worth",t)}removeOnSellGameWorth(t){this.connection.offReducer("sell_game_worth",t)}setPersonName(t){const i={name:t};let s=new Ge(1024);xe.getTypeScriptAlgebraicType().serialize(s,i);let r=s.getBuffer();this.connection.callReducer("set_person_name",r,this.setCallReducerFlags.setPersonNameFlags)}onSetPersonName(t){this.connection.onReducer("set_person_name",t)}removeOnSetPersonName(t){this.connection.offReducer("set_person_name",t)}}class ai{constructor(){p(this,"createPersonFlags","FullUpdate");p(this,"playGreenFlags","FullUpdate");p(this,"playRedFlags","FullUpdate");p(this,"resetBankFlags","FullUpdate");p(this,"sellGameWorthFlags","FullUpdate");p(this,"setPersonNameFlags","FullUpdate")}createPerson(t){this.createPersonFlags=t}playGreen(t){this.playGreenFlags=t}playRed(t){this.playRedFlags=t}resetBank(t){this.resetBankFlags=t}sellGameWorth(t){this.sellGameWorthFlags=t}setPersonName(t){this.setPersonNameFlags=t}}class ci{constructor(t){this.connection=t}get gameState(){return new ii(this.connection.clientCache.getOrCreateTable(qt.tables.game_state))}get person(){return new ni(this.connection.clientCache.getOrCreateTable(qt.tables.person))}}class oi extends ur{}class fr extends yr{constructor(){super(...arguments);p(this,"subscriptionBuilder",()=>new oi(this))}}p(fr,"builder",()=>new Kr(qt,i=>i));function x(e,t={},i=""){const s=document.createElement(e);for(const[r,a]of Object.entries(t))a instanceof HTMLElement?r==="parentElement"&&a.appendChild(s):s.setAttribute(r,a);return s.textContent=i,s}const ge=["\u{1F42D}","\u{1F439}","\u{1F431}","\u{1F436}","\u{1F43B}","\u{1F42F}","\u{1F981}","\u{1F43C}","\u{1F438}","\u{1F432}"];function pi(e,t,i,s){let r=x("div",{id:"game"});x("h2",{parentElement:r},"Panda Farm");const a=x("p",{parentElement:r}),u=x("div",{id:"animals",parentElement:r});u.className="animals";const g=x("p",{parentElement:r},"Highscore: 0$"),T=x("button",{id:"button1",parentElement:r},"Beef \u{1F356}"),m=x("button",{id:"button2",parentElement:r},"Broc \u{1F966}");x("p",{parentElement:r});const w=x("button",{id:"sellbutton",parentElement:r},"Sell");class I{constructor(_){p(this,"element");p(this,"type");this.element=x("div",{},ge[_]),this.element.classList.add("animal"),setTimeout(()=>{this.element.classList.add("active")},10),this.type=_}settype(_){this.element.textContent=ge[_],this.type=_}update(_){if(_.action.tag=="Dead")return this.element.classList.add("animal","dead"),setTimeout(()=>{this.element.remove()},1e3),[];if(_.action.tag=="Dublicate"){const B=new I(this.type);return B.element.classList.add("fresh"),this.element.classList.add("fresh"),setTimeout(()=>{this.element.classList.remove("fresh"),B.element.classList.remove("fresh")},10),this.element.insertAdjacentElement("afterend",B.element),[this,B]}else{if(_.action.tag=="Levelup")return this.type=this.type+1,this.element.classList.remove("active"),setTimeout(()=>{this.element.textContent=ge[this.type],this.element.classList.add("active")},100),[this];if(_.action.tag=="Stay")return this.element.classList.remove("active"),setTimeout(()=>{this.element.classList.add("active")},100),[this]}return console.error("Unknown action type",_.action),[this]}}let U=[];const R=v=>{u.innerHTML="",U=v.map(_=>{const B=new I(_);return u.appendChild(B.element),B})};return e.subscribe(v=>{a.textContent=`bank: ${v.bank}$`,v.lastActionResult.length==U.length&&v.lastActionResult.every((_,B)=>_.animal===U[B].type)?(console.log("merging actions"),U=v.lastActionResult.flatMap((B,Ve)=>U[Ve].update(B)),U.length==0&&(U.push(new I(0)),u.appendChild(U[0].element))):R(v.gameState),g.textContent=`Highscore: ${v.highscoreState.reduce((_,B)=>_+ge[B],"")}`,w.textContent=`Collect ${v.gameState.reduce((_,B)=>_+2**B,0)}$`}),T.classList.add("bigbutton"),m.classList.add("bigbutton"),w.classList.add("bigbutton"),T.onclick=i,m.onclick=s,w.onclick=t,r}function li(e,t,i){const s=x("div",{class:"leaderboard"});x("h2",{parentElement:s},"Leaderboard");const r=x("h3",{},"Change your name, currently: "),a=x("span",{},e.get().name);a.style.textDecoration="underline",r.appendChild(a),s.appendChild(r),r.addEventListener("click",()=>{const g=window.prompt("Your name:",e.get().name)?.trim();g&&g.length>0&&t(g)}),e.subscribe(g=>{a.textContent=`${g.name.slice(0,20)}`});const u=x("div",{});return i.subscribe(g=>{u.innerHTML="",g.sort((T,m)=>m.highscore-T.highscore).slice(0,100);for(const[T,m]of g.entries()){const w=x("p",{class:"leaderitem"},`${T+1}. ${m.name.slice(0,20)}: ${m.highscore}$ : ${m.highscoreState.reduce((I,U)=>I+ge[U],"")}`);u.appendChild(w)}}),s.appendChild(u),s}const mr="pandadb2",ui="remote",wr=new Ur(mr+ui+"-token",""),te=console.log;function Ze(e,t,i,s){const r=`SELECT * FROM person WHERE id == '${t.toHexString()}'`;e.subscriptionBuilder().onApplied(a=>{const u=Array.from(a.db.person.iter()).filter(g=>g.id.toHexString()==t.toHexString());u.length==0?s():i(u[0])}).onError(a=>{te("Error in player subscription",a.event),s()}).subscribe(r)}let Nt=new Vt([]);function Dt(e){e.subscriptionBuilder().onApplied(t=>{Nt.set(Array.from(t.db.person.iter())),te("Competition updated",Nt.get())}).onError(t=>{te("Error in competition subscription",t.event)}).subscribe("SELECT * FROM person WHERE highscore > 0 ")}function yi(e,t,i){wr.set(i),Dt(e);const s=r=>{const a=new Vt(r),u=T=>{Ze(T,t,m=>a.set(m,!0),()=>{})};e.reducers.onPlayGreen(u),e.reducers.onPlayRed(T=>u(T)),e.reducers.onSellGameWorth(u),e.reducers.onSetPersonName(T=>{T.event.status.tag=="Failed"&&alert("Failed to set name: "+T.event.status.value),Dt(e),u(T)}),e.reducers.onResetBank(u);const g={conn:e,player:a};Sr.remove(),gi(g)};Ze(e,t,s,()=>{e.reducers.onCreatePerson(r=>{Ze(e,t,s,()=>{te("Failed to create player, retrying..."),setTimeout(()=>Ar(),1e3)})}),e.reducers.createPerson()})}const Sr=x("h1",{},"Waiting for connection...");document.body.appendChild(Sr);const di="wss://maincloud.spacetimedb.com";function Ar(){return fr.builder().withUri(di).withModuleName(mr).withToken(wr.get()).onConnect(yi).onConnectError((e,t)=>te("onConnectError",t)).build()}Ar();function gi(e){te(e),e.player.subscribe(s=>{if(s.highscore!=e.player.get().highscore&&(te("Highscore updated",s.highscore),Dt(e.conn)),s.bank==0){let r=window.prompt("You have no money left, say please to get more");r&&r.length>0&&e.conn.reducers.resetBank()}});let t=li(e.player,s=>e.conn.reducers.setPersonName(s),Nt);const i=pi(e.player,()=>e.conn.reducers.sellGameWorth(),()=>e.conn.reducers.playRed(),()=>e.conn.reducers.playGreen());document.body.appendChild(i),document.body.appendChild(t)}
